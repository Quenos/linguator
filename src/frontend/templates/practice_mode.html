<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Practice Mode - Linguator</title>
    <!-- Removed HTMX script -->
    <!-- Basic Styling (Optional) -->
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #practice-area { margin-top: 20px; border: 1px solid #ccc; padding: 15px; min-height: 150px; }
        #flashcard { padding: 10px; border: 1px dashed #eee; margin-top: 10px; }

        /* Navigation Button Styles (copied from word_pair_list.html) */
        .nav-links {
            margin-bottom: 20px; /* Use margin-bottom like word_pair_list */
            display: flex; /* Align buttons nicely */
            gap: 10px; /* Space between buttons */
        }
        .nav-button {
            display: inline-block; /* Allows padding and margins */
            padding: 8px 15px;
            background-color: #007bff; /* Example blue */
            color: white !important; /* Ensure text color is white */
            text-decoration: none; /* Remove underline */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s; /* Smooth hover effect */
            font-size: 1em; /* Match default text size */
        }
        .nav-button:hover {
            background-color: #0056b3; /* Darker blue on hover */
            color: white !important; /* Ensure text color stays white */
            text-decoration: none;
        }

        /* Specific style for the start button */
        .start-button {
            /* Inherit base styles from nav-button if desired, or define explicitly */
            display: inline-block; /* Allows padding and margins */
            padding: 8px 15px;
            background-color: #28a745; /* Green */
            color: white !important; /* Ensure text color is white */
            text-decoration: none; /* Remove underline */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s; /* Smooth hover effect */
            font-size: 1em; /* Match default text size */
            margin-bottom: 20px; /* Add some space below */
        }
        .start-button:hover {
             background-color: #218838; /* Darker green */
        }
    </style>
</head>
<body>

<h1>Practice Mode</h1>

<!-- Add navigation links -->
<div class="nav-links">
    <a href="/ui/word-pairs" class="nav-button">Word Pairs List</a>
    <a href="/ui/progress" class="nav-button">View Progress</a>
</div>

<!-- Button to start the practice session -->
<button id="start-practice-btn" class="start-button">
    Start Practice (10 words)
</button>

<!-- Area where the practice questions/feedback will be loaded -->
<div id="practice-area">
    <p>Click "Start Practice" to begin.</p>
</div>

<script>
    // Store the fetched word pairs for the session
    let currentPracticePairs = [];
    let currentQuestionIndex = -1; // Initialize to -1, will be 0 for the first question
    let currentWordPair = null; // Store the currently displayed word pair

    const startButton = document.getElementById('start-practice-btn');
    const practiceArea = document.getElementById('practice-area');

    startButton.addEventListener('click', async () => {
        console.log('Start Practice clicked');
        practiceArea.innerHTML = '<p>Loading questions...</p>'; // Provide immediate feedback
        try {
            // Use the new dedicated practice session endpoint
            const response = await fetch('/practice-session/'); 
            if (!response.ok) {
                // Try to get error detail from response body if possible
                let errorDetail = `HTTP error! status: ${response.status}`;
                try {
                    const errorJson = await response.json();
                    errorDetail = errorJson.detail || errorDetail;
                } catch (e) { /* Ignore if response is not JSON */ }
                throw new Error(errorDetail);
            }
            currentPracticePairs = await response.json(); // Store the pairs
            console.log('Fetched pairs:', currentPracticePairs);

            if (currentPracticePairs && currentPracticePairs.length > 0) {
                currentQuestionIndex = 0; // Set index to the first question
                displayQuestion(currentQuestionIndex);
            } else {
                practiceArea.innerHTML = '<p>No word pairs found to practice.</p>';
            }
        } catch (error) {
            console.error('Error fetching practice pairs:', error);
            practiceArea.innerHTML = `<p>Error loading questions: ${escapeHTML(error.message)}. Please try again.</p>`;
        }
    });

    function displayQuestion(index) {
        if (index < 0 || index >= currentPracticePairs.length) {
            practiceArea.innerHTML = '<p>Invalid question index.</p>'; // Should not happen in normal flow
            return;
        }

        currentWordPair = currentPracticePairs[index]; // Store current pair
        // Generate HTML for the flashcard (only the source word initially)
        practiceArea.innerHTML = `
            <div id="flashcard">
                <h2>Flashcard (${index + 1} / ${currentPracticePairs.length})</h2>
                <p><strong>Source Word:</strong> ${escapeHTML(currentWordPair.source_word)}</p>
                <div id="answer-area">
                    <!-- Answer will be revealed here -->
                </div>
                <div id="feedback-area">
                     <button id="show-answer-btn" class="start-button">Show Answer</button>
                </div>
                <!-- Placeholder for navigation (Ticket 4) -->
                <!-- <button>Next</button> -->
            </div>
        `;
        console.log(`Displayed question ${index + 1}:`, currentWordPair);

        // Add event listener to the new button
        document.getElementById('show-answer-btn').addEventListener('click', revealAnswer);
    }

    function revealAnswer() {
        if (!currentWordPair) return; // Should not happen

        const answerArea = document.getElementById('answer-area');
        const feedbackArea = document.getElementById('feedback-area');

        // Display the target word
        answerArea.innerHTML = `<p><strong>Target Word:</strong> ${escapeHTML(currentWordPair.target_word)}</p>`;

        // Replace "Show Answer" with "Correct" / "Incorrect" buttons
        feedbackArea.innerHTML = `
            <p>Did you know the answer?</p>
            <button id="correct-btn" style="background-color: #28a745; color: white; margin-right: 5px;">Correct</button>
            <button id="incorrect-btn" style="background-color: #dc3545; color: white;">Incorrect</button>
        `;

        // Add event listeners to feedback buttons
        document.getElementById('correct-btn').addEventListener('click', () => handleFeedback(true));
        document.getElementById('incorrect-btn').addEventListener('click', () => handleFeedback(false));
    }

    function handleFeedback(isCorrect) {
        // console.log(`User feedback recorded: ${isCorrect ? 'Correct' : 'Incorrect'} for word pair ID: ${currentWordPair._id}`); // Placeholder for recording result (Epic 4, Ticket 2)

        // --- Start: Epic 4, Ticket 2 Implementation ---
        if (currentWordPair && currentWordPair._id) {
            const resultData = {
                word_pair_id: currentWordPair._id,
                is_correct: isCorrect
            };

            fetch('/practice-session/results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(resultData)
            })
            .then(response => {
                if (!response.ok) {
                    // Attempt to read error detail from response
                    return response.json().then(err => {
                        throw new Error(err.detail || `HTTP error! Status: ${response.status}`);
                    }).catch(() => {
                        // Fallback if response is not JSON or has no detail
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json(); // Or handle success response if needed
            })
            .then(data => {
                console.log('Practice result saved:', data);
            })
            .catch(error => {
                console.error('Error saving practice result:', error);
                // Optionally, display a user-facing error message in the UI
                // feedbackArea.innerHTML += `<p style="color: red; font-size: small;">Error saving result: ${escapeHTML(error.message)}</p>`;
            });
        } else {
            console.error('Cannot record feedback: currentWordPair or its ID is missing.');
        }
        // --- End: Epic 4, Ticket 2 Implementation ---

        const flashcardDiv = document.getElementById('flashcard');
        const feedbackArea = document.getElementById('feedback-area');

        // Provide visual feedback
        flashcardDiv.style.border = isCorrect ? '2px solid green' : '2px solid red';
        feedbackArea.innerHTML = `<p style="font-weight: bold; color: ${isCorrect ? 'green' : 'red'};">Marked as ${isCorrect ? 'Correct' : 'Incorrect'}.</p>`;

        // Add a "Next" button
        if (currentQuestionIndex < currentPracticePairs.length - 1) {
            feedbackArea.innerHTML += '<br><button id="next-btn" style="margin-top: 10px;">Next Question</button>';
            document.getElementById('next-btn').addEventListener('click', goToNextQuestion);
        } else {
            // Last question was answered
            feedbackArea.innerHTML += '<br><button id="finish-btn" style="margin-top: 10px;">Finish Session</button>';
            document.getElementById('finish-btn').addEventListener('click', finishSession);
        }
    }

    function goToNextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentPracticePairs.length) {
            displayQuestion(currentQuestionIndex);
        } else {
            // This case should technically be handled by the finish button now,
            // but keep it as a safeguard.
            finishSession();
        }
    }

    function finishSession() {
         practiceArea.innerHTML = `
            <h2>Session Complete!</h2>
            <p>You have reviewed all ${currentPracticePairs.length} word pairs.</p>
            <p><button onclick="location.reload()">Practice Again</button></p>
        `;
        // Reset state if needed (optional)
        currentPracticePairs = [];
        currentQuestionIndex = -1;
        currentWordPair = null;
    }

    // Basic HTML escaping function to prevent XSS
    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

</script>

</body>
</html> 