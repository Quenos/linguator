<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Pair List</title>
    <!-- Basic Styling (optional) -->
    <style>
        body { font-family: sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .actions { text-align: center; }
        .actions button { margin: 0 5px; cursor: pointer; padding: 5px 10px; border-radius: 3px; border: 1px solid #ccc; }
        .actions .edit-btn { background-color: #ffc107; color: black; }
        .actions .edit-btn:hover { background-color: #e0a800; }
        .actions .delete-btn { background-color: #dc3545; color: white; }
        .actions .delete-btn:hover { background-color: #c82333; }
        #loading-indicator, #empty-message { text-align: center; color: gray; }
        .htmx-indicator { display: inline-block; }
        .htmx-request .htmx-indicator { display: inline-block; }
        .htmx-request.htmx-indicator { display: inline-block; }
        /* Form Styles */
        .form-container { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 5px; background-color: #f9f9f9;}
        .form-container label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-container input[type="text"],
        .form-container select,
        .form-container textarea { width: calc(100% - 16px); padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 3px; }
        .form-container textarea { resize: vertical; min-height: 60px; }
        .form-container button[type="submit"] { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .form-container button[type="submit"]:hover { background-color: #218838; }
        .form-feedback { margin-top: 10px; padding: 10px; border-radius: 3px; display: none; }
        .form-feedback.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .form-feedback.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px;
            border-radius: 5px;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #edit-form button[type="button"] { /* Style for Cancel button */
             background-color: #6c757d;
             color: white;
             margin-left: 10px;
             padding: 10px 15px;
             border: none;
             border-radius: 3px;
             cursor: pointer;
        }
        #edit-form button[type="button"]:hover {
             background-color: #5a6268;
        }

    </style>
</head>
<body>

    <h1>Word Pairs</h1>

    <!-- Placeholder for Search/Filter (Ticket 5) -->
    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
        <input type="search" id="search-input" placeholder="Search by source or target word..." style="padding: 8px; flex-grow: 1;">
        <select id="category-filter" style="padding: 8px;">
            <option value="">All Categories</option>
            <option value="Noun">Noun</option>
            <option value="Pronoun">Pronoun</option>
            <option value="Verb">Verb</option>
            <option value="Adjective">Adjective</option>
            <option value="Adverb">Adverb</option>
            <option value="Preposition">Preposition</option>
            <option value="Conjunction">Conjunction</option>
            <option value="Interjection">Interjection</option>
            <option value="Phrase">Phrase</option>
            <option value="Sentence">Sentence</option>
            <option value="Other">Other</option>
        </select>
    </div>

    <!-- Table that will be populated by JS -->
    <table>
        <thead>
            <tr>
                <th>Source Word</th>
                <th>Target Word</th>
                <th>Category</th>
                <th>Example Sentence</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="word-pair-table-body">
            <!-- Initial loading message (will be replaced by JS) -->
            <tr><td colspan="5" id="loading-indicator">Loading word pairs...</td></tr>
        </tbody>
    </table>

    <!-- Add New Word Pair Form (Ticket 2) -->
    <div id="add-form-container" class="form-container">
        <h2>Add New Word Pair</h2>
        <form id="add-form">
            <div>
                <label for="add_source_word">Source Word:</label>
                <input type="text" id="add_source_word" name="source_word" required>
            </div>
            <div>
                <label for="add_target_word">Target Word:</label>
                <input type="text" id="add_target_word" name="target_word" required>
            </div>
            <div>
                <label for="add_category">Category:</label>
                <select id="add_category" name="category" required>
                    <option value="" disabled selected>Select a category</option>
                    <option value="Noun">Noun</option>
                    <option value="Pronoun">Pronoun</option>
                    <option value="Verb">Verb</option>
                    <option value="Adjective">Adjective</option>
                    <option value="Adverb">Adverb</option>
                    <option value="Preposition">Preposition</option>
                    <option value="Conjunction">Conjunction</option>
                    <option value="Interjection">Interjection</option>
                    <option value="Phrase">Phrase</option>
                    <option value="Sentence">Sentence</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div>
                <label for="add_example_sentence">Example Sentence:</label>
                <textarea id="add_example_sentence" name="example_sentence"></textarea>
            </div>
            <button type="submit">Save Word Pair</button>
        </form>
        <div id="add-form-feedback" class="form-feedback"></div>
    </div>

    <!-- Edit Word Pair Modal (Ticket 3) -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Edit Word Pair</h2>
        <form id="edit-form" class="form-container">
            <input type="hidden" id="edit_id" name="id">
            <div>
                <label for="edit_source_word">Source Word:</label>
                <input type="text" id="edit_source_word" name="source_word" required>
            </div>
            <div>
                <label for="edit_target_word">Target Word:</label>
                <input type="text" id="edit_target_word" name="target_word" required>
            </div>
            <div>
                <label for="edit_category">Category:</label>
                 <select id="edit_category" name="category" required>
                    <option value="" disabled>Select a category</option>
                    <option value="Noun">Noun</option>
                    <option value="Pronoun">Pronoun</option>
                    <option value="Verb">Verb</option>
                    <option value="Adjective">Adjective</option>
                    <option value="Adverb">Adverb</option>
                    <option value="Preposition">Preposition</option>
                    <option value="Conjunction">Conjunction</option>
                    <option value="Interjection">Interjection</option>
                    <option value="Phrase">Phrase</option>
                    <option value="Sentence">Sentence</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div>
                <label for="edit_example_sentence">Example Sentence:</label>
                <textarea id="edit_example_sentence" name="example_sentence"></textarea>
            </div>
            <button type="submit">Save Changes</button>
            <button type="button" id="cancel-edit-btn">Cancel</button> <!-- Added Cancel button -->
        </form>
        <div id="edit-form-feedback" class="form-feedback"></div>
      </div>
    </div>


    <!-- Include JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.getElementById('word-pair-table-body');
            const addForm = document.getElementById('add-form');
            const addFormFeedback = document.getElementById('add-form-feedback');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const editFormFeedback = document.getElementById('edit-form-feedback');
            const closeModalBtn = editModal.querySelector('.close-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const searchInput = document.getElementById('search-input'); // Added
            const categoryFilter = document.getElementById('category-filter'); // Added

            let allWordPairs = []; // To store all fetched word pairs for filtering

            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') {
                  if (unsafe === null || typeof unsafe === 'undefined') return '';
                  if (typeof unsafe === 'number') return unsafe.toString();
                  console.warn('escapeHtml received unexpected type:', typeof unsafe, unsafe);
                  return '';
                }
                return unsafe
                         .replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
            }

            function displayFeedback(element, message, type) {
                element.textContent = message;
                element.className = 'form-feedback'; // Reset classes first
                element.classList.add(type);
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }

            function displayErrorInTable(message) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">${escapeHtml(message)}</td></tr>`;
            }

            function displayWordPairs(wordPairs, currentSearchTerm = '', currentCategory = '') {
                console.log('Displaying word pairs:', wordPairs);
                tableBody.innerHTML = '';

                if (!wordPairs || wordPairs.length === 0) {
                    if(currentSearchTerm || currentCategory) {
                         tableBody.innerHTML = `<tr id="empty-message"><td colspan="5">No word pairs match your search criteria.</td></tr>`;
                    } else {
                         tableBody.innerHTML = `<tr id="empty-message"><td colspan="5">No word pairs found. Add one below!</td></tr>`;
                    }
                    return;
                }

                wordPairs.forEach(pair => {
                    const row = tableBody.insertRow();
                    row.dataset.id = pair._id;
                    row.innerHTML = `
                        <td>${escapeHtml(pair.source_word)}</td>
                        <td>${escapeHtml(pair.target_word)}</td>
                        <td>${escapeHtml(pair.category)}</td>
                        <td>${escapeHtml(pair.example_sentence)}</td>
                        <td class="actions">
                            <button class="edit-btn" data-id="${pair._id}">Edit</button>
                            <button class="delete-btn" data-id="${pair._id}">Delete</button>
                        </td>
                    `;
                });
            }

            function filterAndDisplayWordPairs() {
                const currentPairs = allWordPairs;
                const searchTerm = searchInput.value.trim().toLowerCase();
                const selectedCategory = categoryFilter.value;
                const selectedCategoryLower = selectedCategory.toLowerCase();
                console.log(`Filtering with searchTerm: "${searchTerm}", selectedCategory: "${selectedCategory}" (using ${currentPairs.length} total pairs)`);

                const filteredPairs = currentPairs.filter(pair => {
                    const sourceWord = (pair && pair.source_word || '').toLowerCase();
                    const targetWord = (pair && pair.target_word || '').toLowerCase();
                    const category = (pair && pair.category || '').toLowerCase();

                    const matchesSearch = !searchTerm ||
                                        sourceWord.includes(searchTerm) ||
                                        targetWord.includes(searchTerm);

                    const matchesCategory = selectedCategory === "" || category === selectedCategoryLower;

                    return matchesSearch && matchesCategory;
                });
                console.log('Filtered pairs:', filteredPairs);

                displayWordPairs(filteredPairs, searchTerm, selectedCategory);
            }

            addForm.addEventListener('submit', function(event) {
                event.preventDefault();
                addFormFeedback.style.display = 'none';
                addForm.querySelector('button[type="submit"]').disabled = true;

                const formData = new FormData(addForm);
                const data = Object.fromEntries(formData.entries());

                if (!data.source_word || !data.target_word || !data.category) {
                    displayFeedback(addFormFeedback, 'Please fill out Source Word, Target Word, and Category.', 'error');
                    addForm.querySelector('button[type="submit"]').disabled = false;
                    return;
                }

                fetch('/word-pairs/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.detail || `Failed to save word pair. Status: ${response.status}`);
                        }).catch(() => {
                            throw new Error(`Failed to save word pair. Status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(newPair => {
                    displayFeedback(addFormFeedback, 'Word pair saved successfully!', 'success');
                    addForm.reset();
                    allWordPairs.push(newPair);
                    filterAndDisplayWordPairs();
                })
                .catch(error => {
                    console.error('Error adding word pair:', error);
                    displayFeedback(addFormFeedback, 'Error adding word pair: ' + error.message, 'error');
                })
                .finally(() => {
                    addForm.querySelector('button[type="submit"]').disabled = false;
                });
            });

            // --- Edit Functionality ---
            function openEditModal(pair) {
                editFormFeedback.textContent = '';
                editFormFeedback.style.display = 'none';

                // Populate the form
                document.getElementById('edit_id').value = pair._id;
                document.getElementById('edit_source_word').value = pair.source_word;
                document.getElementById('edit_target_word').value = pair.target_word;
                document.getElementById('edit_category').value = pair.category;
                document.getElementById('edit_example_sentence').value = pair.example_sentence || ''; // Handle null/undefined

                editModal.style.display = 'block';
            }

            editForm.addEventListener('submit', function(event) {
                event.preventDefault();
                editFormFeedback.style.display = 'none';
                editForm.querySelector('button[type="submit"]').disabled = true;

                const formData = new FormData(editForm);
                const data = Object.fromEntries(formData.entries());
                const wordPairId = data.id;

                if (!wordPairId) {
                     displayFeedback(editFormFeedback, 'Error: Could not identify the word pair to update.', 'error');
                     editForm.querySelector('button[type="submit"]').disabled = false;
                     return;
                }

                if (!data.source_word || !data.target_word || !data.category) {
                    displayFeedback(editFormFeedback, 'Please fill out Source Word, Target Word, and Category.', 'error');
                    editForm.querySelector('button[type="submit"]').disabled = false;
                    return;
                }

                const updateData = {
                    source_word: data.source_word,
                    target_word: data.target_word,
                    category: data.category,
                    example_sentence: data.example_sentence
                };

                fetch(`/word-pairs/${wordPairId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.detail || `Failed to update word pair. Status: ${response.status}`);
                        }).catch(() => {
                            throw new Error(`Failed to update word pair. Status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(updatedPair => {
                    displayFeedback(editFormFeedback, 'Word pair updated successfully!', 'success');
                    closeEditModal();
                    const index = allWordPairs.findIndex(pair => pair._id === updatedPair._id);
                    if (index !== -1) {
                        allWordPairs[index] = updatedPair;
                    }
                    filterAndDisplayWordPairs();
                })
                .catch(error => {
                    console.error('Error updating word pair:', error);
                    displayFeedback(editFormFeedback, `Update Error: ${error.message}`, 'error');
                })
                .finally(() => {
                    editForm.querySelector('button[type="submit"]').disabled = false;
                });
            });

            // --- Define closeEditModal function ---
            function closeEditModal() {
                editModal.style.display = 'none';
                editForm.reset(); // Clear the form fields
                editFormFeedback.style.display = 'none'; // Hide any previous feedback
            }

            // --- Delete Functionality ---
            async function deleteWordPair(id) {
                if (!confirm('Are you sure you want to delete this word pair?')) {
                    return;
                }
                try {
                    const response = await fetch(`/word-pairs/${id}`, {
                        method: 'DELETE',
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                    }
                    // Re-fetch and display the updated list
                    await fetchWordPairs();
                    // Optionally display success feedback somewhere, maybe near the table?
                    // displayFeedback(someGlobalFeedbackElement, 'Word pair deleted successfully.', 'success');
                } catch (error) {
                    console.error('Error deleting word pair:', error);
                    // Display error feedback, maybe near the table?
                    // displayFeedback(someGlobalFeedbackElement, `Error deleting word pair: ${error.message}`, 'error');
                    displayErrorInTable(`Error deleting word pair: ${error.message}`); // Show error in table area
                }
            }

            // Table click delegation (for Edit and Delete buttons)
            tableBody.addEventListener('click', async function(event) {
                const target = event.target;

                // Handle Edit button click
                if (target.classList.contains('edit-btn')) {
                    const button = event.target;
                    const wordPairId = button.dataset.id;

                    if (!wordPairId) {
                        console.error("Edit button clicked but no ID found.");
                        displayFeedback(addFormFeedback, 'Could not find word pair ID to edit.', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`/word-pairs/${wordPairId}`);
                        if (!response.ok) {
                             let errorDetail = `HTTP error! Status: ${response.status}`;
                             try {
                                const err = await response.json();
                                errorDetail = err.detail || errorDetail;
                             } catch(e) { /* ignore */ }
                             throw new Error(errorDetail);
                        }
                        const pair = await response.json();

                        openEditModal(pair);
                    } catch (error) {
                        console.error('Error fetching word pair for edit:', error);
                        displayFeedback(addFormFeedback, `Error loading data for edit: ${error.message}`, 'error');
                    }
                }

                // Handle Delete button click
                if (target.classList.contains('delete-btn')) {
                    const id = target.dataset.id;
                    if (!id) {
                         console.error("Delete button clicked but no ID found.");
                         alert('Could not find word pair ID to delete.');
                         return;
                    }
                    await deleteWordPair(id); // Call the delete function
                }
            });

            // --- Initial Data Fetch ---
            async function fetchWordPairs() {
                tableBody.innerHTML = `<tr><td colspan="5" id="loading-indicator">Loading word pairs...</td></tr>`;
                console.log('Fetching word pairs...');
                try {
                    const response = await fetch('/word-pairs/');
                    if (!response.ok) {
                        let errorDetail = `HTTP error! status: ${response.status}`;
                        try {
                           const err = await response.json();
                           errorDetail = err.detail || errorDetail;
                        } catch(e) { /* ignore if response isn't json */}
                        throw new Error(errorDetail);
                    }
                    const data = await response.json();
                    console.log('Data received from fetch:', data);

                    allWordPairs = Array.isArray(data) ? data : []; // Ensure it's an array
                    console.log('allWordPairs assigned:', allWordPairs);

                    // --- REVERTING MODIFICATION START ---
                    // Restore the call to the filter function for initial load.
                    filterAndDisplayWordPairs();
                    // --- REVERTING MODIFICATION END ---

                    // console.log('Calling displayWordPairs directly for initial load.'); // Removed test code
                    // displayWordPairs(allWordPairs); // Removed test code

                } catch (error) {
                    console.error('Error fetching word pairs:', error);
                    allWordPairs = [];
                    displayErrorInTable(`Could not load word pairs: ${error.message}`);
                }
            }

            // Add event listeners for search and filter
            searchInput.addEventListener('input', filterAndDisplayWordPairs);
            categoryFilter.addEventListener('change', filterAndDisplayWordPairs);

            closeModalBtn.onclick = closeEditModal;
            cancelEditBtn.onclick = closeEditModal;
            window.onclick = function(event) {
              if (event.target == editModal) {
                closeEditModal();
              }
            }

            // Initial fetch when the page loads
            fetchWordPairs();
        });
    </script>

</body>
</html> 